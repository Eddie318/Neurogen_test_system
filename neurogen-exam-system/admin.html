<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考试系统后台管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: white;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .question-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .question-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .question-item h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .question-item p {
            margin-bottom: 8px;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>💼 穆桥销售测验系统 - 后台管理</h1>
        <p>题库管理 | API配置 | 数据统计</p>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">📊 数据概览</button>
            <button class="nav-tab" onclick="switchTab('questions')">📝 题库管理</button>
            <button class="nav-tab" onclick="switchTab('import')">📤 批量导入</button>
            <button class="nav-tab" onclick="switchTab('api')">⚙️ API配置</button>
        </div>

        <!-- 数据概览 -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalQuestions">0</div>
                    <div class="stat-label">题库总数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="singleQuestions">0</div>
                    <div class="stat-label">单选题</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="multipleQuestions">0</div>
                    <div class="stat-label">多选题</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCategories">0</div>
                    <div class="stat-label">知识分类</div>
                </div>
            </div>

            <div class="card">
                <h2>📈 题库分布</h2>
                <div id="categoryStats"></div>
            </div>
        </div>

        <!-- 题库管理 -->
        <div id="questions" class="tab-content">
            <div class="card">
                <h2>➕ 添加新题目</h2>
                <form id="questionForm">
                    <div class="form-group">
                        <label>题目类型</label>
                        <select id="questionType">
                            <option value="single">单选题</option>
                            <option value="multiple">多选题</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>知识分类</label>
                        <input type="text" id="questionCategory" placeholder="如：疾病、药物、治疗等" required>
                    </div>
                    
                    <div class="form-group">
                        <label>题目内容</label>
                        <textarea id="questionText" placeholder="请输入题目内容" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>选项A</label>
                        <input type="text" id="optionA" placeholder="选项A内容" required>
                    </div>
                    
                    <div class="form-group">
                        <label>选项B</label>
                        <input type="text" id="optionB" placeholder="选项B内容" required>
                    </div>
                    
                    <div class="form-group">
                        <label>选项C</label>
                        <input type="text" id="optionC" placeholder="选项C内容" required>
                    </div>
                    
                    <div class="form-group">
                        <label>选项D</label>
                        <input type="text" id="optionD" placeholder="选项D内容" required>
                    </div>
                    
                    <div class="form-group">
                        <label>正确答案</label>
                        <input type="text" id="correctAnswer" placeholder="单选题输入：A 多选题输入：ABC" required>
                        <small style="color: #666;">提示：单选题输入一个字母，多选题输入多个字母</small>
                    </div>
                    
                    <div class="form-group">
                        <label>答案解析</label>
                        <textarea id="questionExplanation" placeholder="请提供答案解析"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">💾 保存题目</button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">🔄 清空表单</button>
                </form>
            </div>

            <div class="card">
                <h2>📋 题库列表 (<span id="questionCount">0</span>题)</h2>
                <div class="question-list" id="questionList"></div>
            </div>
        </div>

        <!-- 批量导入 -->
        <div id="import" class="tab-content">
            <div class="card">
                <h2>📤 Excel批量导入</h2>
                <div style="border: 2px dashed #667eea; border-radius: 10px; padding: 40px; text-align: center; background: #f8f9ff; cursor: pointer; transition: all 0.3s ease;" 
                     onclick="document.getElementById('excelFileInput').click()" 
                     ondrop="handleFileDrop(event)" 
                     ondragover="event.preventDefault(); this.style.borderColor='#4CAF50'; this.style.background='#f0fff0';" 
                     ondragleave="this.style.borderColor='#667eea'; this.style.background='#f8f9ff';">
                    <div style="font-size: 48px; margin-bottom: 15px;">📊</div>
                    <h3>点击选择或拖拽Excel文件到此处</h3>
                    <p>支持 .xlsx, .xls 格式</p>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
                </div>
                
                <div id="uploadProgress" style="display: none; margin-top: 20px;">
                    <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                        <div id="progressBar" style="height: 20px; background: linear-gradient(45deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <p id="progressText" style="text-align: center; margin-top: 10px; color: #666;">正在处理...</p>
                </div>
                
                <div id="importResults" style="display: none; margin-top: 20px;"></div>
            </div>

            <div class="card">
                <h2>📋 Excel格式要求</h2>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #28a745; margin-bottom: 15px;">✅ 你的Excel格式完美支持！</h3>
                    <p><strong>当前支持的Excel列结构：</strong></p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">
                        <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #667eea;">
                            <strong>列A:</strong> 题目类别<br>
                            <small>如：疾病、药物、治疗</small>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #667eea;">
                            <strong>列B:</strong> 题目类型<br>
                            <small>单选题/多选题</small>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #667eea;">
                            <strong>列C:</strong> 题目内容<br>
                            <small>完整的题目描述</small>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #667eea;">
                            <strong>列D:</strong> 正确答案<br>
                            <small>单选：A，多选：ABC</small>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                            <strong>列E:</strong> 选项A<br>
                            <small>第一个选项内容</small>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                            <strong>列F:</strong> 选项B<br>
                            <small>第二个选项内容</small>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                            <strong>列G:</strong> 选项C<br>
                            <small>第三个选项内容</small>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                            <strong>列H:</strong> 选项D<br>
                            <small>第四个选项内容</small>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
                    <h4 style="color: #856404; margin-bottom: 10px;">💡 导入提示</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #856404;">
                        <li>第一行为标题行，会自动跳过</li>
                        <li>支持单选题（答案如：A、B、C、D）</li>
                        <li>支持多选题（答案如：ABC、AD、BC等）</li>
                        <li>空行会自动跳过</li>
                        <li>建议一次导入不超过500道题目</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>🔄 GitHub在线题库同步</h2>
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2196f3;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">🔐 GitHub配置</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">GitHub Token:</label>
                        <input type="password" id="githubToken" placeholder="输入GitHub Personal Access Token" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <small style="color: #666;">
                            获取方式：GitHub → Settings → Developer settings → Personal access tokens → 生成新Token (需要repo权限)
                        </small>
                    </div>
                    <button onclick="saveGitHubConfig()" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        💾 保存配置
                    </button>
                    <span id="githubConfigStatus" style="color: #666; margin-left: 10px;"></span>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #28a745; margin-bottom: 15px;">🚀 自动同步</h3>
                    <p>一键将题库同步到GitHub，所有销售设备将自动获得最新题库</p>
                    <button onclick="autoSyncToGitHub()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin-right: 10px; font-size: 16px;">
                        🔄 立即同步到GitHub
                    </button>
                    <button onclick="exportQuestionBank()" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        📤 导出备份
                    </button>
                    <div id="syncStatus" style="margin-top: 10px; font-size: 14px;"></div>
                </div>
            </div>

            <div class="card">
                <h2>💾 题库导出/导入</h2>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 15px;">📤 导出题库</h3>
                    <p>将当前题库导出为JSON文件，可在其他设备导入使用</p>
                    <button id="exportBtn" onclick="exportQuestionBank()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        📤 导出题库
                    </button>
                    <span id="exportStatus" style="color: #666;"></span>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #28a745; margin-bottom: 15px;">📥 导入题库</h3>
                    <p>选择之前导出的题库JSON文件进行导入</p>
                    <input type="file" id="jsonFileInput" accept=".json" style="margin-bottom: 10px;" onchange="handleJsonUpload(event)">
                    <br>
                    <button id="importBtn" onclick="importQuestionBank()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        📥 导入题库
                    </button>
                    <span id="importStatus" style="color: #666;"></span>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
                    <h4 style="color: #856404; margin-bottom: 10px;">💡 使用说明</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #856404;">
                        <li>导出的文件包含所有题目信息，可在任何设备导入</li>
                        <li>导入会<strong>覆盖</strong>当前题库，请谨慎操作</li>
                        <li>建议定期导出题库作为备份</li>
                        <li>团队成员可以共享导出的题库文件</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>📋 导入历史记录</h2>
                <div id="importHistory">
                    <p style="color: #666; text-align: center; padding: 20px;">暂无导入记录</p>
                </div>
            </div>
        </div>

        <!-- API配置 -->
        <div id="api" class="tab-content">
            <div class="card">
                <h2>🔗 API服务配置</h2>
                <div class="form-group">
                    <label>API服务商</label>
                    <select id="apiProvider" onchange="updateApiConfig()">
                        <option value="openai">OpenAI (GPT-3.5/GPT-4)</option>
                        <option value="qwen">通义千问 (Qwen)</option>
                        <option value="zhipu">智谱AI (GLM)</option>
                        <option value="proxy">代理服务器 (推荐)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>API地址</label>
                    <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions">
                </div>
                
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="apiKey" placeholder="请输入API Key">
                </div>
                
                <div class="form-group">
                    <label>模型名称</label>
                    <input type="text" id="modelName" placeholder="gpt-3.5-turbo">
                </div>
                
                <button class="btn" onclick="saveApiConfig()">💾 保存配置</button>
                <button class="btn btn-secondary" onclick="testApiConnection()">🔍 测试连接</button>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #ffeaa7;">
                    <h4 style="color: #856404; margin-bottom: 10px;">⚠️ 重要提示</h4>
                    <p style="color: #856404; margin: 0; font-size: 14px;">
                        <strong>关于CORS限制：</strong><br>
                        • OpenAI API: 支持浏览器直接调用<br>
                        • 通义千问/智谱AI: 受CORS限制，需要代理服务器<br>
                        • 代理服务器: 通过Vercel部署，解决CORS问题（推荐）<br>
                        • 如遇到CORS错误，系统会自动使用本地评估报告
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 全局变量
        let questionBank = [];
        let currentEditingId = null;
        let importHistory = [];

        // 页面加载时初始化
        window.addEventListener('load', function() {
            loadQuestionBank();
            loadApiConfig();
            loadImportHistory();
            updateDashboard();
            showAllQuestions();
        });

        // Excel文件上传处理
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        // 拖拽文件处理
        function handleFileDrop(event) {
            event.preventDefault();
            event.target.style.borderColor = '#667eea';
            event.target.style.background = '#f8f9ff';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processExcelFile(files[0]);
            }
        }

        // 处理Excel文件
        function processExcelFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showAlert('请选择Excel文件（.xlsx或.xls格式）', 'error');
                return;
            }

            showProgress(true);
            updateProgress(10, '正在读取Excel文件...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    updateProgress(30, '正在解析Excel数据...');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 转换为JSON数组
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    updateProgress(50, '正在处理题目数据...');
                    
                    // 解析题目数据
                    const questions = parseExcelData(jsonData);
                    
                    updateProgress(80, '正在保存题目...');
                    
                    // 导入题目
                    importQuestions(questions, file.name);
                    
                    updateProgress(100, '导入完成！');
                    
                    setTimeout(() => {
                        showProgress(false);
                        showImportResults(questions.length, file.name);
                    }, 1000);
                    
                } catch (error) {
                    console.error('解析Excel文件出错:', error);
                    showProgress(false);
                    showAlert('Excel文件解析失败，请检查文件格式', 'error');
                }
            };
            
            reader.onerror = function() {
                showProgress(false);
                showAlert('文件读取失败', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 解析Excel数据
        function parseExcelData(jsonData) {
            const questions = [];
            
            // 跳过标题行，从第二行开始
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // 跳过空行
                if (!row || row.length < 6 || !row[0] || !row[2]) {
                    continue;
                }
                
                try {
                    const question = {
                        id: Date.now() + i, // 生成唯一ID
                        category: String(row[0]).trim(), // 题目类别
                        type: String(row[1]).includes('多选') ? 'multiple' : 'single', // 题目类型
                        question: String(row[2]).trim(), // 题目内容
                        options: [
                            String(row[4] || '').trim(), // 选项A
                            String(row[5] || '').trim(), // 选项B
                            String(row[6] || '').trim(), // 选项C
                            String(row[7] || '').trim()  // 选项D
                        ].filter(opt => opt), // 过滤空选项
                        correct: parseCorrectAnswer(String(row[3]).trim()), // 正确答案
                        explanation: '' // 暂时为空，可以后续添加
                    };
                    
                    // 验证题目数据
                    if (question.options.length >= 2 && question.correct.length > 0) {
                        questions.push(question);
                    }
                    
                } catch (error) {
                    console.warn(`第${i + 1}行数据解析失败:`, error);
                }
            }
            
            return questions;
        }

        // 解析正确答案
        function parseCorrectAnswer(answerStr) {
            const answer = answerStr.toUpperCase();
            const correctIndexes = [];
            
            for (let char of answer) {
                if (char >= 'A' && char <= 'D') {
                    const index = char.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
                    if (!correctIndexes.includes(index)) {
                        correctIndexes.push(index);
                    }
                }
            }
            
            return correctIndexes;
        }

        // 导入题目到题库
        function importQuestions(questions, fileName) {
            const beforeCount = questionBank.length;
            
            // 添加到题库
            questionBank = questionBank.concat(questions);
            
            // 保存到本地存储
            saveQuestionBank();
            
            // 记录导入历史
            const importRecord = {
                id: Date.now(),
                fileName: fileName,
                importTime: new Date().toLocaleString(),
                count: questions.length,
                totalBefore: beforeCount,
                totalAfter: questionBank.length
            };
            
            importHistory.unshift(importRecord);
            saveImportHistory();
            
            // 更新界面
            updateDashboard();
            showAllQuestions();
            updateImportHistory();
        }

        // 显示导入结果
        function showImportResults(count, fileName) {
            const resultsDiv = document.getElementById('importResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px;">
                    <h3 style="margin-bottom: 15px;">🎉 导入成功！</h3>
                    <p><strong>文件名:</strong> ${fileName}</p>
                    <p><strong>导入题目数:</strong> ${count} 道</p>
                    <p><strong>当前总题目数:</strong> ${questionBank.length} 道</p>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="switchTab('questions')">📝 查看题库</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importResults').style.display='none'">关闭</button>
                    </div>
                </div>
            `;
            
            showAlert(`成功导入 ${count} 道题目！`, 'success');
        }

        // 显示/隐藏进度条
        function showProgress(show) {
            document.getElementById('uploadProgress').style.display = show ? 'block' : 'none';
            if (!show) {
                updateProgress(0, '');
            }
        }

        // 更新进度条
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // 保存导入历史
        function saveImportHistory() {
            localStorage.setItem('importHistory', JSON.stringify(importHistory));
        }

        // 加载导入历史
        function loadImportHistory() {
            const saved = localStorage.getItem('importHistory');
            if (saved) {
                importHistory = JSON.parse(saved);
            }
        }

        // 更新导入历史显示
        function updateImportHistory() {
            const historyDiv = document.getElementById('importHistory');
            
            if (importHistory.length === 0) {
                historyDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">暂无导入记录</p>';
                return;
            }
            
            historyDiv.innerHTML = importHistory.map(record => `
                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f8f9fa;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #667eea; margin: 0;">${record.fileName}</h4>
                        <span style="color: #666; font-size: 12px;">${record.importTime}</span>
                    </div>
                    <p style="margin: 5px 0; color: #666;">
                        导入题目: <strong>${record.count}</strong> 道 | 
                        导入前: ${record.totalBefore} 道 | 
                        导入后: ${record.totalAfter} 道
                    </p>
                </div>
            `).join('');
        }

        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签的激活状态
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示目标标签内容
            document.getElementById(tabName).classList.add('active');
            
            // 激活对应标签按钮
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // 如果切换到数据概览，更新统计
            if (tabName === 'dashboard') {
                updateDashboard();
            }
            
            // 如果切换到题库管理，刷新题目列表
            if (tabName === 'questions') {
                showAllQuestions();
            }
            
            // 如果切换到导入页面，更新导入历史
            if (tabName === 'import') {
                updateImportHistory();
            }
        }

        // 更新数据概览
        function updateDashboard() {
            const stats = calculateStats();
            
            document.getElementById('totalQuestions').textContent = stats.total;
            document.getElementById('singleQuestions').textContent = stats.single;
            document.getElementById('multipleQuestions').textContent = stats.multiple;
            document.getElementById('totalCategories').textContent = stats.categories;
            
            // 显示分类统计
            const categoryDiv = document.getElementById('categoryStats');
            categoryDiv.innerHTML = '';
            
            if (Object.keys(stats.categoryCount).length === 0) {
                categoryDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">暂无数据</p>';
                return;
            }
            
            Object.entries(stats.categoryCount).forEach(([category, count]) => {
                const categoryItem = document.createElement('div');
                categoryItem.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;';
                categoryItem.innerHTML = `<span>${category}</span><span><strong>${count}题</strong></span>`;
                categoryDiv.appendChild(categoryItem);
            });
        }

        // 计算统计数据
        function calculateStats() {
            const stats = {
                total: questionBank.length,
                single: 0,
                multiple: 0,
                categories: 0,
                categoryCount: {}
            };
            
            questionBank.forEach(q => {
                if (q.type === 'single') stats.single++;
                if (q.type === 'multiple') stats.multiple++;
                
                if (!stats.categoryCount[q.category]) {
                    stats.categoryCount[q.category] = 0;
                }
                stats.categoryCount[q.category]++;
            });
            
            stats.categories = Object.keys(stats.categoryCount).length;
            
            return stats;
        }

        // 保存题目
        document.getElementById('questionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                id: currentEditingId || Date.now(),
                type: document.getElementById('questionType').value,
                category: document.getElementById('questionCategory').value,
                question: document.getElementById('questionText').value,
                options: [
                    document.getElementById('optionA').value,
                    document.getElementById('optionB').value,
                    document.getElementById('optionC').value,
                    document.getElementById('optionD').value
                ],
                correct: [],
                explanation: document.getElementById('questionExplanation').value
            };
            
            // 处理正确答案
            const correctAnswer = document.getElementById('correctAnswer').value.toUpperCase();
            formData.correct = correctAnswer.split('').map(letter => letter.charCodeAt(0) - 65);
            
            // 验证数据
            if (formData.options.some(opt => !opt.trim())) {
                showAlert('所有选项都必须填写', 'error');
                return;
            }
            
            if (formData.correct.some(x => x >= 4 || x < 0)) {
                showAlert('正确答案必须是A、B、C、D中的字母', 'error');
                return;
            }
            
            // 保存或更新题目
            if (currentEditingId) {
                const index = questionBank.findIndex(q => q.id === currentEditingId);
                questionBank[index] = formData;
                currentEditingId = null;
            } else {
                questionBank.push(formData);
            }
            
            saveQuestionBank();
            showAlert('题目保存成功', 'success');
            clearForm();
            showAllQuestions();
            updateDashboard();
        });

        // 清空表单
        function clearForm() {
            document.getElementById('questionForm').reset();
            currentEditingId = null;
        }

        // 显示所有题目
        function showAllQuestions() {
            const container = document.getElementById('questionList');
            const countElement = document.getElementById('questionCount');
            
            container.innerHTML = '';
            countElement.textContent = questionBank.length;
            
            if (questionBank.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">暂无题目，请添加题目</p>';
                return;
            }
            
            questionBank.forEach(question => {
                const questionDiv = createQuestionElement(question);
                container.appendChild(questionDiv);
            });
        }

        // 创建题目元素
        function createQuestionElement(question) {
            const div = document.createElement('div');
            div.className = 'question-item';
            
            const correctLetters = question.correct.map(i => String.fromCharCode(65 + i)).join('');
            
            div.innerHTML = `
                <h3>[${question.category}] ${question.type === 'single' ? '单选题' : '多选题'}</h3>
                <p><strong>题目：</strong>${question.question}</p>
                <p><strong>选项：</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    ${question.options.map((option, index) => 
                        `<li style="margin: 5px 0; ${question.correct.includes(index) ? 'color: #28a745; font-weight: bold;' : ''}">${String.fromCharCode(65 + index)}. ${option}</li>`
                    ).join('')}
                </ul>
                <p><strong>正确答案：</strong>${correctLetters}</p>
                ${question.explanation ? `<p><strong>解析：</strong>${question.explanation}</p>` : ''}
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="editQuestion(${question.id})">✏️ 编辑</button>
                    <button class="btn btn-danger" onclick="deleteQuestion(${question.id})">🗑️ 删除</button>
                </div>
            `;
            
            return div;
        }

        // 编辑题目
        function editQuestion(id) {
            const question = questionBank.find(q => q.id === id);
            if (!question) return;
            
            currentEditingId = id;
            
            // 填充表单
            document.getElementById('questionType').value = question.type;
            document.getElementById('questionCategory').value = question.category;
            document.getElementById('questionText').value = question.question;
            document.getElementById('optionA').value = question.options[0] || '';
            document.getElementById('optionB').value = question.options[1] || '';
            document.getElementById('optionC').value = question.options[2] || '';
            document.getElementById('optionD').value = question.options[3] || '';
            document.getElementById('questionExplanation').value = question.explanation || '';
            document.getElementById('correctAnswer').value = question.correct.map(i => String.fromCharCode(65 + i)).join('');
            
            // 切换到题库管理标签
            switchTab('questions');
            
            // 滚动到表单
            document.getElementById('questionForm').scrollIntoView({ behavior: 'smooth' });
            
            showAlert('题目已载入编辑器', 'success');
        }

        // 删除题目
        function deleteQuestion(id) {
            if (confirm('确定要删除这道题目吗？')) {
                questionBank = questionBank.filter(q => q.id !== id);
                saveQuestionBank();
                showAllQuestions();
                updateDashboard();
                showAlert('题目删除成功', 'success');
            }
        }

        // 显示提示信息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; min-width: 250px;';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 保存题库到本地存储
        function saveQuestionBank() {
            localStorage.setItem('questionBank', JSON.stringify(questionBank));
        }

        // 保存GitHub配置
        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                showAlert('请输入GitHub Token', 'error');
                return;
            }
            
            // 保存到localStorage
            localStorage.setItem('githubToken', token);
            showAlert('GitHub配置已保存', 'success');
            document.getElementById('githubConfigStatus').textContent = '✅ 已配置';
            document.getElementById('githubConfigStatus').style.color = '#28a745';
        }

        // 加载GitHub配置
        function loadGitHubConfig() {
            const token = localStorage.getItem('githubToken');
            if (token) {
                document.getElementById('githubToken').value = token;
                document.getElementById('githubConfigStatus').textContent = '✅ 已配置';
                document.getElementById('githubConfigStatus').style.color = '#28a745';
            }
        }

        // 自动同步到GitHub
        async function autoSyncToGitHub() {
            const token = localStorage.getItem('githubToken');
            
            if (!token) {
                showAlert('请先配置GitHub Token', 'error');
                return;
            }
            
            if (questionBank.length === 0) {
                showAlert('题库为空，无法同步', 'error');
                return;
            }
            
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.innerHTML = '🔄 正在同步到GitHub...';
            syncStatus.style.color = '#007bff';
            
            try {
                // 获取当前文件的SHA（用于更新文件）
                const currentFileResponse = await fetch('https://api.github.com/repos/Eddie318/Neurogen_test_system/contents/questionbank.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (currentFileResponse.ok) {
                    const currentFile = await currentFileResponse.json();
                    sha = currentFile.sha;
                }
                
                // 准备更新的内容
                const content = JSON.stringify(questionBank, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // 更新文件
                const updateResponse = await fetch('https://api.github.com/repos/Eddie318/Neurogen_test_system/contents/questionbank.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `自动同步题库 - ${new Date().toLocaleString()} (${questionBank.length}道题)`,
                        content: encodedContent,
                        sha: sha
                    })
                });
                
                if (updateResponse.ok) {
                    showAlert(`题库同步成功！共同步 ${questionBank.length} 道题目`, 'success');
                    syncStatus.innerHTML = `✅ 同步成功 (${questionBank.length}道题) - ${new Date().toLocaleString()}`;
                    syncStatus.style.color = '#28a745';
                } else {
                    const errorData = await updateResponse.json();
                    throw new Error(`GitHub API错误: ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('同步失败:', error);
                showAlert(`同步失败: ${error.message}`, 'error');
                syncStatus.innerHTML = `❌ 同步失败: ${error.message}`;
                syncStatus.style.color = '#dc3545';
            }
        }

        // 老版本的同步函数（保留作为备用）
        async function syncQuestionBankToGitHub() {
            showAlert('请使用上方的"立即同步到GitHub"功能', 'error');
        }

        // 从本地存储加载题库
        function loadQuestionBank() {
            const saved = localStorage.getItem('questionBank');
            if (saved) {
                questionBank = JSON.parse(saved);
            }
        }

        // 更新API配置
        function updateApiConfig() {
            const provider = document.getElementById('apiProvider').value;
            const urlInput = document.getElementById('apiUrl');
            const modelInput = document.getElementById('modelName');
            
            switch (provider) {
                case 'openai':
                    urlInput.value = 'https://api.openai.com/v1/chat/completions';
                    modelInput.value = 'gpt-3.5-turbo';
                    break;
                case 'qwen':
                    urlInput.value = 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation';
                    modelInput.value = 'qwen-turbo';
                    break;
                case 'zhipu':
                    urlInput.value = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
                    modelInput.value = 'glm-4';
                    break;
                case 'proxy':
                    urlInput.value = 'https://neurogen-qwen.vercel.app/api/proxy';
                    modelInput.value = 'qwen-turbo';
                    break;
            }
        }

        // 保存API配置
        function saveApiConfig() {
            const config = {
                provider: document.getElementById('apiProvider').value,
                url: document.getElementById('apiUrl').value,
                key: document.getElementById('apiKey').value,
                model: document.getElementById('modelName').value
            };
            
            localStorage.setItem('apiConfig', JSON.stringify(config));
            showAlert('API配置保存成功', 'success');
            
            // 自动同步API配置到GitHub
            syncApiConfigToGitHub();
        }

        // 同步API配置到GitHub
        async function syncApiConfigToGitHub() {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                console.log('未配置GitHub Token，跳过API配置同步');
                return;
            }
            
            const apiConfig = JSON.parse(localStorage.getItem('apiConfig') || '{}');
            
            // 不同步API Key到GitHub（安全考虑）
            const publicConfig = {
                provider: apiConfig.provider,
                url: apiConfig.url,
                model: apiConfig.model,
                lastUpdated: new Date().toISOString()
            };
            
            try {
                // 获取当前文件的SHA
                const currentFileResponse = await fetch('https://api.github.com/repos/Eddie318/Neurogen_test_system/contents/apiconfig.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (currentFileResponse.ok) {
                    const currentFile = await currentFileResponse.json();
                    sha = currentFile.sha;
                }
                
                // 准备更新的内容
                const content = JSON.stringify(publicConfig, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // 更新文件
                const updateResponse = await fetch('https://api.github.com/repos/Eddie318/Neurogen_test_system/contents/apiconfig.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `自动同步API配置 - ${new Date().toLocaleString()}`,
                        content: encodedContent,
                        sha: sha
                    })
                });
                
                if (updateResponse.ok) {
                    console.log('API配置同步到GitHub成功');
                } else {
                    console.error('API配置同步失败:', await updateResponse.text());
                }
                
            } catch (error) {
                console.error('API配置同步失败:', error);
            }
        }

        // 加载API配置
        function loadApiConfig() {
            const saved = localStorage.getItem('apiConfig');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('apiProvider').value = config.provider || 'openai';
                document.getElementById('apiUrl').value = config.url || '';
                document.getElementById('apiKey').value = config.key || '';
                document.getElementById('modelName').value = config.model || '';
            }
            updateApiConfig();
        }

        // 测试API连接
        function testApiConnection() {
            const config = {
                url: document.getElementById('apiUrl').value,
                key: document.getElementById('apiKey').value,
                model: document.getElementById('modelName').value
            };
            
            if (!config.key) {
                showAlert('请先输入API Key', 'error');
                return;
            }
            
            showAlert('正在测试API连接...', 'success');
            
            // 这里可以添加实际的API测试逻辑
            setTimeout(() => {
                showAlert('API连接测试完成（请在考试系统中验证实际功能）', 'success');
            }, 2000);
        }

        // 导出题库为JSON
        function exportQuestionBank() {
            if (questionBank.length === 0) {
                showAlert('题库为空，无法导出', 'error');
                document.getElementById('exportStatus').textContent = '题库为空';
                return;
            }
            
            const dataStr = JSON.stringify(questionBank, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `穆桥销售题库_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('题库导出成功', 'success');
            document.getElementById('exportStatus').textContent = `已导出 ${questionBank.length} 道题目`;
        }

        // 处理JSON文件上传
        let selectedJsonFile = null;
        
        function handleJsonUpload(event) {
            selectedJsonFile = event.target.files[0];
            if (selectedJsonFile) {
                document.getElementById('importStatus').textContent = `已选择: ${selectedJsonFile.name}`;
            }
        }

        // 导入题库从JSON
        function importQuestionBank() {
            if (!selectedJsonFile) {
                showAlert('请先选择JSON文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 验证数据格式
                    if (!Array.isArray(importedData)) {
                        throw new Error('文件格式不正确：应为题目数组');
                    }
                    
                    // 验证题目结构
                    let validCount = 0;
                    const validQuestions = importedData.filter(item => {
                        if (item && item.question && item.answer && item.optionA && item.optionB) {
                            validCount++;
                            return true;
                        }
                        return false;
                    });
                    
                    if (validQuestions.length === 0) {
                        throw new Error('文件中没有有效的题目数据');
                    }
                    
                    // 确认导入
                    if (confirm(`确定要导入 ${validQuestions.length} 道题目吗？\n这将覆盖当前题库的所有内容！`)) {
                        questionBank = validQuestions;
                        saveQuestionBank();
                        updateDashboard();
                        showAlert(`题库导入成功，共导入 ${validQuestions.length} 道题目`, 'success');
                        document.getElementById('importStatus').textContent = `导入成功：${validQuestions.length} 道题目`;
                        
                        // 清空文件选择
                        document.getElementById('jsonFileInput').value = '';
                        selectedJsonFile = null;
                    }
                    
                } catch (error) {
                    showAlert(`导入失败: ${error.message}`, 'error');
                    document.getElementById('importStatus').textContent = '导入失败';
                }
            };
            
            reader.readAsText(selectedJsonFile);
        }

        // 添加导出按钮到数据概览
        document.addEventListener('DOMContentLoaded', function() {
            const dashboardCard = document.querySelector('#dashboard .card:last-child');
            if (dashboardCard) {
                const exportBtn = document.createElement('button');
                exportBtn.className = 'btn btn-success';
                exportBtn.textContent = '📤 导出题库';
                exportBtn.onclick = exportQuestionBank;
                dashboardCard.appendChild(exportBtn);
            }
            
            // 加载GitHub配置
            loadGitHubConfig();
        });
    </script>
</body>
</html>
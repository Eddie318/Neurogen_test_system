<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>穆桥销售测验系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex: 1;
        }

        .start-screen {
            text-align: center;
        }

        .start-screen h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .start-screen p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .question-card {
            display: none;
        }

        .question-card.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .question-type {
            background: #f0f0f0;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            color: #666;
        }

        .question-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #333;
        }

        .options {
            margin-bottom: 25px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .option:hover {
            background: #e9ecef;
        }

        .option.selected {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .option.correct {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .option.incorrect {
            background: #ffebee;
            border-color: #f44336;
        }

        .option-letter {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
            font-size: 16px;
            line-height: 1.4;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }

        .feedback.incorrect {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        .feedback-icon {
            font-size: 20px;
            margin-right: 10px;
        }

        .feedback-text {
            font-size: 16px;
            line-height: 1.5;
        }

        .next-btn {
            margin-top: 20px;
            display: none;
        }

        .next-btn.show {
            display: block;
        }

        .result-screen {
            display: none;
            text-align: center;
        }

        .result-screen.show {
            display: block;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px auto;
        }

        .ai-report {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: left;
        }

        .ai-report h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .ai-report p {
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-config {
            background: #fff3cd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .api-config h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .api-config input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .alert {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .alert h3 {
            margin-bottom: 10px;
        }

        .admin-link {
            background: #856404;
            text-decoration: none;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💼 穆桥销售测验系统</h1>
            <div id="loadingStatus" style="font-size: 14px; margin-top: 10px; padding: 5px 10px; border-radius: 15px; background: rgba(255,255,255,0.2);">
                🔄 正在加载最新题库...
            </div>
        </div>

        <div class="card">
            <!-- 开始界面 -->
            <div id="startScreen" class="start-screen">
                <h2>准备开始考试</h2>
                <p>本次考试将从题库中随机选择题目，包含单选题和多选题。完成后将获得AI生成的个性化学习报告。</p>
                
                <div class="alert">
                    <h3>💡 系统配置</h3>
                    <p class="management-hint">本系统使用后台管理系统中配置的API设置。如需修改API配置，请访问后台管理系统。</p>
                </div>
                
                <button class="btn" onclick="startExam()">开始考试</button>
                <button class="btn admin-link" onclick="openAdminPanel()" style="background: #6c757d; margin-top: 10px;">🔧 后台管理</button>
            </div>

            <!-- 考试界面 -->
            <div id="examScreen" class="question-card">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="question-header">
                    <span class="question-number" id="questionNumber">第1题 / 共10题</span>
                    <span class="question-type" id="questionType">单选题</span>
                </div>
                
                <div class="question-text" id="questionText"></div>
                
                <div class="options" id="optionsContainer"></div>
                
                <div class="feedback" id="feedback">
                    <div class="feedback-text" id="feedbackText"></div>
                </div>
                
                <button class="btn next-btn" id="nextBtn" onclick="nextQuestion()">下一题</button>
            </div>

            <!-- 结果界面 -->
            <div id="resultScreen" class="result-screen">
                <h2>🎉 考试完成！</h2>
                <div class="score-circle" id="scoreCircle">8/10</div>
                <p id="scoreText">您的得分：80</p>
                
                <div class="ai-report" id="aiReport">
                    <div class="loading" id="reportLoading">
                        <div class="loading-spinner"></div>
                        <p>AI正在生成您的学习报告...</p>
                    </div>
                </div>
                
                <button class="btn" onclick="restartExam()">重新考试</button>
                <button class="btn admin-link" onclick="openAdminPanel()" style="background: #6c757d; margin-top: 10px;">🔧 后台管理</button>
            </div>
        </div>
    </div>

    <script>
        // 题库数据 - 从后台管理系统加载
        let questionBank = [];

        // 考试状态
        let currentExam = {
            questions: [],
            currentIndex: 0,
            score: 0,
            answers: [],
            selectedOptions: [],
            startTime: null,
            endTime: null
        };

        // 页面加载时初始化
        window.addEventListener('load', async function() {
            // 检查是否为销售模式
            const urlParams = new URLSearchParams(window.location.search);
            const isSalesMode = urlParams.get('mode') === 'sales';
            
            if (isSalesMode) {
                // 销售模式：隐藏管理功能
                document.title = '穆桥销售测验系统';
                console.log('🎯 销售模式启动');
                
                // 添加销售模式样式
                const style = document.createElement('style');
                style.textContent = `
                    .admin-link { display: none !important; }
                    .management-hint { display: none !important; }
                `;
                document.head.appendChild(style);
            }
            
            // 优先从GitHub加载最新题库
            const questionBankSuccess = await loadQuestionBankFromGitHub();
            
            // 如果GitHub加载失败，尝试本地备份
            if (!questionBankSuccess) {
                loadQuestionBankFromStorage();
            }
            
            // 优先从GitHub加载API配置
            const apiConfigSuccess = await loadApiConfigFromGitHub();
            
            // 如果GitHub加载失败，尝试本地备份
            if (!apiConfigSuccess) {
                loadApiConfigFromStorage();
            }
            
            // 检查题库是否为空
            if (questionBank.length === 0) {
                showNoQuestionsAlert();
            }
            
            console.log('考试系统已加载，题库包含', questionBank.length, '道题目');
        });

        // 从GitHub加载在线题库
        async function loadQuestionBankFromGitHub() {
            try {
                console.log('正在从CDN加载最新题库...');
                const response = await fetch('https://cdn.jsdelivr.net/gh/Eddie318/Neurogen_test_system@main/questionbank.json');
                
                if (response.ok) {
                    const onlineQuestionBank = await response.json();
                    if (Array.isArray(onlineQuestionBank) && onlineQuestionBank.length > 0) {
                        questionBank = onlineQuestionBank;
                        // 同步到本地存储作为备份
                        localStorage.setItem('questionBank', JSON.stringify(questionBank));
                        console.log('✅ 成功加载在线题库:', questionBank.length, '道题目');
                        
                        // 显示加载状态
                        const statusDiv = document.getElementById('loadingStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = `✅ 已加载最新题库 (${questionBank.length}题)`;
                            statusDiv.style.color = '#28a745';
                        }
                        return true;
                    }
                }
            } catch (error) {
                console.warn('从GitHub加载题库失败，尝试加载本地备份:', error);
            }
            
            // 如果在线加载失败，尝试加载本地备份
            return loadQuestionBankFromStorage();
        }

        // 从本地存储加载题库（备份方案）
        function loadQuestionBankFromStorage() {
            const saved = localStorage.getItem('questionBank');
            if (saved) {
                try {
                    questionBank = JSON.parse(saved);
                    console.log('📂 加载本地备份题库:', questionBank.length, '道题目');
                    
                    const statusDiv = document.getElementById('loadingStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = `📂 使用本地备份题库 (${questionBank.length}题)`;
                        statusDiv.style.color = '#ffc107';
                    }
                    return true;
                } catch (error) {
                    console.error('题库数据解析失败:', error);
                    questionBank = [];
                }
            }
            
            // 如果没有任何题库，显示错误
            const statusDiv = document.getElementById('loadingStatus');
            if (statusDiv) {
                statusDiv.innerHTML = '❌ 无法加载题库，请稍后重试';
                statusDiv.style.color = '#dc3545';
            }
            return false;
        }

        // 从GitHub加载API配置
        async function loadApiConfigFromGitHub() {
            try {
                console.log('正在从CDN加载API配置...');
                const response = await fetch('https://cdn.jsdelivr.net/gh/Eddie318/Neurogen_test_system@main/apiconfig.json');
                
                if (response.ok) {
                    const onlineConfig = await response.json();
                    
                    // 直接使用从GitHub获取的完整配置（包括API Key）
                    localStorage.setItem('apiConfig', JSON.stringify(onlineConfig));
                    console.log('✅ 成功加载在线API配置:', onlineConfig.provider);
                    
                    // 更新状态显示
                    const statusDiv = document.getElementById('loadingStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = `✅ 已加载最新题库 (${questionBank.length}题) | API: ${onlineConfig.provider}`;
                    }
                    return true;
                }
            } catch (error) {
                console.warn('从GitHub加载API配置失败:', error);
            }
            
            return loadApiConfigFromStorage();
        }

        // 从本地存储加载API配置（备份方案）
        function loadApiConfigFromStorage() {
            const saved = localStorage.getItem('apiConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    console.log('📂 使用本地备份API配置:', config.provider);
                    return true;
                } catch (error) {
                    console.error('API配置加载失败:', error);
                }
            }
            return false;
        }

        // 显示没有题目的提示
        function showNoQuestionsAlert() {
            const startScreen = document.getElementById('startScreen');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert';
            
            // 检查是否为销售模式
            const urlParams = new URLSearchParams(window.location.search);
            const isSalesMode = urlParams.get('mode') === 'sales';
            
            if (isSalesMode) {
                alertDiv.innerHTML = `
                    <h3>📚 题库加载中...</h3>
                    <p>正在从云端加载最新题库，请稍候...</p>
                    <button class="btn" onclick="location.reload()" style="background: #28a745; color: white;">
                        🔄 重新加载
                    </button>
                `;
            } else {
                alertDiv.innerHTML = `
                    <h3>⚠️ 题库为空</h3>
                    <p class="management-hint">当前没有可用的题目，请先到后台管理系统添加题目。</p>
                    <button class="btn admin-link" onclick="openAdminPanel()">
                        🔧 打开后台管理
                    </button>
                `;
            }
            
            startScreen.insertBefore(alertDiv, startScreen.children[1]);
        }

        // 打开后台管理（新窗口）
        function openAdminPanel() {
            // 尝试打开admin.html，如果同目录存在的话
            const adminUrl = window.location.href.replace(/[^/]*$/, 'admin.html');
            window.open(adminUrl, '_blank');
        }

        // 初始化考试
        function startExam() {
            // 重新加载题库，确保使用最新数据
            loadQuestionBankFromStorage();
            
            if (questionBank.length === 0) {
                alert('题库为空，请先到后台添加题目');
                return;
            }
            
            if (questionBank.length < 10) {
                if (!confirm(`当前题库只有${questionBank.length}道题目，是否继续考试？`)) {
                    return;
                }
            }
            
            // 检查后台API配置
            const savedConfig = localStorage.getItem('apiConfig');
            if (!savedConfig) {
                if (!confirm('未找到API配置，将无法生成AI评估报告，是否继续？')) {
                    return;
                }
            } else {
                try {
                    const config = JSON.parse(savedConfig);
                    if (!config.key) {
                        if (!confirm('后台未配置API Key，将无法生成AI评估报告，是否继续？')) {
                            return;
                        }
                    }
                } catch (error) {
                    if (!confirm('API配置读取失败，将无法生成AI评估报告，是否继续？')) {
                        return;
                    }
                }
            }
            
            // 随机选择题目数量（最多10道，如果题库不足10道就全选）
            const examCount = Math.min(10, questionBank.length);
            const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
            currentExam.questions = shuffled.slice(0, examCount);
            currentExam.currentIndex = 0;
            currentExam.score = 0;
            currentExam.answers = [];
            currentExam.selectedOptions = [];
            currentExam.startTime = new Date();
            
            // 保存考试开始记录
            saveExamRecord('start');
            
            // 切换到考试界面
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('examScreen').style.display = 'block';
            
            // 显示第一题
            showQuestion();
        }

        // 显示题目
        function showQuestion() {
            const question = currentExam.questions[currentExam.currentIndex];
            const progress = ((currentExam.currentIndex + 1) / currentExam.questions.length) * 100;
            
            // 更新进度条
            document.getElementById('progressFill').style.width = progress + '%';
            
            // 更新题目信息
            document.getElementById('questionNumber').textContent = `第${currentExam.currentIndex + 1}题 / 共${currentExam.questions.length}题`;
            document.getElementById('questionType').textContent = question.type === 'single' ? '单选题' : '多选题';
            document.getElementById('questionText').textContent = question.question;
            
            // 生成选项
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.onclick = () => selectOption(index);
                
                optionElement.innerHTML = `
                    <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                    <div class="option-text">${option}</div>
                `;
                
                optionsContainer.appendChild(optionElement);
            });
            
            // 重置状态
            currentExam.selectedOptions = [];
            document.getElementById('feedback').classList.remove('show');
            document.getElementById('nextBtn').classList.remove('show');
        }

        // 选择选项
        function selectOption(index) {
            const question = currentExam.questions[currentExam.currentIndex];
            const options = document.querySelectorAll('.option');
            
            if (question.type === 'single') {
                // 单选题：清除所有选择，只选中当前项
                options.forEach(opt => opt.classList.remove('selected'));
                options[index].classList.add('selected');
                currentExam.selectedOptions = [index];
            } else {
                // 多选题：切换当前项的选中状态
                if (currentExam.selectedOptions.includes(index)) {
                    currentExam.selectedOptions = currentExam.selectedOptions.filter(i => i !== index);
                    options[index].classList.remove('selected');
                } else {
                    currentExam.selectedOptions.push(index);
                    options[index].classList.add('selected');
                }
            }
            
            // 如果有选择，显示提交按钮
            if (currentExam.selectedOptions.length > 0) {
                const nextBtn = document.getElementById('nextBtn');
                nextBtn.textContent = '提交答案';
                nextBtn.onclick = submitAnswer;
                nextBtn.classList.add('show');
            }
        }

        // 提交答案
        function submitAnswer() {
            const question = currentExam.questions[currentExam.currentIndex];
            const isCorrect = checkAnswer(question, currentExam.selectedOptions);
            
            // 记录答案
            currentExam.answers.push({
                question: question,
                userAnswer: currentExam.selectedOptions,
                isCorrect: isCorrect
            });
            
            if (isCorrect) {
                currentExam.score++;
            }
            
            // 显示反馈
            showFeedback(isCorrect, question);
            
            // 更新按钮
            const nextBtn = document.getElementById('nextBtn');
            if (currentExam.currentIndex < currentExam.questions.length - 1) {
                nextBtn.textContent = '下一题';
                nextBtn.onclick = nextQuestion;
            } else {
                nextBtn.textContent = '查看结果';
                nextBtn.onclick = showResults;
            }
        }

        // 检查答案
        function checkAnswer(question, userAnswer) {
            const correct = question.correct.slice().sort();
            const user = userAnswer.slice().sort();
            return JSON.stringify(correct) === JSON.stringify(user);
        }

        // 显示反馈
        function showFeedback(isCorrect, question) {
            const feedback = document.getElementById('feedback');
            const feedbackText = document.getElementById('feedbackText');
            
            // 标记选项
            const options = document.querySelectorAll('.option');
            options.forEach((option, index) => {
                if (question.correct.includes(index)) {
                    option.classList.add('correct');
                } else if (currentExam.selectedOptions.includes(index)) {
                    option.classList.add('incorrect');
                }
            });
            
            // 显示反馈信息
            feedback.className = `feedback show ${isCorrect ? 'correct' : 'incorrect'}`;
            feedbackText.innerHTML = `
                <span class="feedback-icon">${isCorrect ? '✅' : '❌'}</span>
                <strong>${isCorrect ? '回答正确！' : '回答错误'}</strong><br>
                ${question.explanation || ''}
            `;
        }

        // 下一题
        function nextQuestion() {
            currentExam.currentIndex++;
            showQuestion();
        }

        // 显示结果
        function showResults() {
            currentExam.endTime = new Date();
            const duration = Math.round((currentExam.endTime - currentExam.startTime) / 1000 / 60); // 分钟
            const accuracy = (currentExam.score / currentExam.questions.length * 100).toFixed(0);
            
            // 保存考试完成记录
            saveExamRecord('complete', {
                score: currentExam.score,
                total: currentExam.questions.length,
                accuracy: accuracy,
                duration: duration,
                answers: currentExam.answers
            });
            
            // 切换到结果界面
            document.getElementById('examScreen').style.display = 'none';
            document.getElementById('resultScreen').classList.add('show');
            
            // 显示分数
            document.getElementById('scoreCircle').textContent = `${currentExam.score}/${currentExam.questions.length}`;
            document.getElementById('scoreText').textContent = `您的得分：${currentExam.score}`;
            
            // 生成AI报告
            generateAIReport();
        }

        // 生成AI报告
        async function generateAIReport() {
            const reportContainer = document.getElementById('aiReport');
            const loadingElement = document.getElementById('reportLoading');
            
            try {
                // 获取API配置
                let apiConfig = getApiConfig();
                
                // 准备详细的考试数据
                const examData = prepareExamData();
                
                // 尝试调用AI API生成报告
                let aiReport = null;
                
                if (apiConfig.key) {
                    try {
                        aiReport = await callAIForReport(apiConfig, examData);
                    } catch (error) {
                        console.warn('AI API调用失败:', error);
                    }
                }
                
                // 生成报告（AI报告或本地报告）
                const finalReport = aiReport || generateLocalReport(examData);
                
                // 显示报告
                loadingElement.style.display = 'none';
                reportContainer.innerHTML = `
                    <h3>📊 ${aiReport ? 'AI智能' : '本地'}评估报告</h3>
                    <div style="white-space: pre-line; line-height: 1.6;">${finalReport}</div>
                    ${!aiReport ? `
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; font-size: 14px;">
                            💡 <strong>提示：</strong>当前为本地生成报告。<br>
                            如需AI智能分析，请在后台配置有效的API Key。<br>
                            注意：通义千问和智谱AI等服务可能受CORS限制，建议使用OpenAI API或配置代理服务器。
                        </div>
                    ` : ''}
                `;
                
            } catch (error) {
                console.error('生成报告时出错:', error);
                
                // 生成安全的本地报告
                const fallbackData = prepareFallbackExamData();
                const localReport = generateLocalReport(fallbackData);
                
                loadingElement.style.display = 'none';
                reportContainer.innerHTML = `
                    <h3>📊 考试评估报告</h3>
                    <div style="white-space: pre-line; line-height: 1.6;">${localReport}</div>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 14px; border: 1px solid #ffeaa7;">
                        ⚠️ <strong>系统提示：</strong>报告生成过程中遇到问题，已切换为本地分析。
                    </div>
                `;
            }
        }

        // 获取API配置
        function getApiConfig() {
            // 直接从后台配置加载
            const saved = localStorage.getItem('apiConfig');
            let apiKey = '';
            
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    apiKey = config.key || '';
                } catch (error) {
                    console.error('加载API配置失败:', error);
                }
            }
            
            return {
                key: apiKey,
                url: getApiUrl(),
                model: getApiModel()
            };
        }

        // 获取API地址
        function getApiUrl() {
            const saved = localStorage.getItem('apiConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    return config.url || 'https://api.openai.com/v1/chat/completions';
                } catch (error) {
                    return 'https://api.openai.com/v1/chat/completions';
                }
            }
            return 'https://api.openai.com/v1/chat/completions';
        }

        // 获取API模型
        function getApiModel() {
            const saved = localStorage.getItem('apiConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    return config.model || 'gpt-3.5-turbo';
                } catch (error) {
                    return 'gpt-3.5-turbo';
                }
            }
            return 'gpt-3.5-turbo';
        }

        // 准备考试数据（安全版本）
        function prepareExamData() {
            try {
                const wrongAnswers = currentExam.answers ? currentExam.answers.filter(a => !a.isCorrect) : [];
                const categories = {};
                const detailedQuestions = [];
                
                // 安全地处理答案数据并收集完整题目信息
                if (currentExam.answers && Array.isArray(currentExam.answers)) {
                    currentExam.answers.forEach((answer, index) => {
                        if (answer && answer.question) {
                            const category = answer.question.category || '未分类';
                            
                            // 分类统计
                            if (!categories[category]) {
                                categories[category] = { total: 0, correct: 0 };
                            }
                            categories[category].total++;
                            if (answer.isCorrect) {
                                categories[category].correct++;
                            }
                            
                            // 收集完整题目信息
                            const questionDetail = {
                                questionNumber: index + 1,
                                category: category,
                                type: answer.question.type === 'single' ? '单选题' : '多选题',
                                question: answer.question.question || '题目内容缺失',
                                options: {
                                    A: answer.question.optionA || '',
                                    B: answer.question.optionB || '',
                                    C: answer.question.optionC || '',
                                    D: answer.question.optionD || ''
                                },
                                correctAnswer: answer.question.answer || '',
                                userAnswer: answer.userAnswer || '',
                                isCorrect: answer.isCorrect,
                                explanation: answer.question.explanation || ''
                            };
                            detailedQuestions.push(questionDetail);
                        }
                    });
                }
                
                const duration = (currentExam.endTime && currentExam.startTime) ? 
                    Math.round((currentExam.endTime - currentExam.startTime) / 1000 / 60) : 0;
                
                return {
                    totalQuestions: currentExam.questions ? currentExam.questions.length : 0,
                    correctCount: currentExam.score || 0,
                    accuracy: currentExam.questions && currentExam.questions.length > 0 ? 
                        (currentExam.score / currentExam.questions.length * 100).toFixed(1) : '0',
                    duration: duration,
                    categories: categories,
                    wrongAnswers: wrongAnswers,
                    detailedQuestions: detailedQuestions, // 新增：完整题目信息
                    examDetails: {
                        startTime: currentExam.startTime,
                        endTime: currentExam.endTime,
                        totalScore: currentExam.score,
                        maxScore: currentExam.questions ? currentExam.questions.length : 0
                    }
                };
            } catch (error) {
                console.error('准备考试数据时出错:', error);
                return prepareFallbackExamData();
            }
        }

        // 准备备用考试数据
        function prepareFallbackExamData() {
            return {
                totalQuestions: currentExam.questions ? currentExam.questions.length : 10,
                correctCount: currentExam.score || 0,
                accuracy: currentExam.questions && currentExam.questions.length > 0 ? 
                    (currentExam.score / currentExam.questions.length * 100).toFixed(1) : '0',
                duration: 0,
                categories: { '医学知识': { total: currentExam.questions ? currentExam.questions.length : 10, correct: currentExam.score || 0 } },
                wrongAnswers: [],
                examDetails: {
                    startTime: currentExam.startTime || new Date(),
                    endTime: currentExam.endTime || new Date(),
                    questions: []
                }
            };
        }

        // 调用AI生成报告（改进版本）
        async function callAIForReport(apiConfig, examData) {
            const prompt = generatePrompt(examData);
            
            // 根据不同的API服务商构建不同的请求格式
            let requestBody, headers;
            
            // 检查是否是Google Gemini API
            if (apiConfig.url.includes('googleapis.com')) {
                // Google Gemini API格式 - 需要在URL中包含API Key
                const urlWithKey = `${apiConfig.url}?key=${apiConfig.key}`;
                apiConfig.url = urlWithKey;
                
                requestBody = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 1000,
                        temperature: 0.7
                    }
                };
                headers = {
                    'Content-Type': 'application/json'
                };
            } else if (apiConfig.url.includes('dashscope.aliyuncs.com')) {
                // 通义千问API格式
                requestBody = {
                    model: apiConfig.model,
                    input: {
                        prompt: prompt
                    },
                    parameters: {
                        max_tokens: 1000,
                        temperature: 0.7
                    }
                };
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.key}`,
                    'X-DashScope-SSE': 'disable'
                };
            } else if (apiConfig.url.includes('bigmodel.cn')) {
                // 智谱AI API格式
                requestBody = {
                    model: apiConfig.model,
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 1000,
                    temperature: 0.7
                };
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.key}`
                };
            } else {
                // OpenAI兼容格式
                requestBody = {
                    model: apiConfig.model,
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 1000,
                    temperature: 0.7
                };
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.key}`
                };
            }

            try {
                let fetchOptions = {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                };

                // 如果是通义千问API且URL包含vercel或其他代理服务，使用代理格式
                if (apiConfig.url.includes('dashscope.aliyuncs.com') || 
                    (apiConfig.url.includes('vercel.app') || apiConfig.url.includes('workers.dev'))) {
                    // 如果是代理服务器，重新构造请求
                    if (!apiConfig.url.includes('dashscope.aliyuncs.com')) {
                        // 为代理服务器使用通义千问格式
                        const qwenRequestBody = {
                            model: apiConfig.model,
                            input: {
                                prompt: prompt
                            },
                            parameters: {
                                max_tokens: 1000,
                                temperature: 0.7
                            }
                        };
                        fetchOptions.body = JSON.stringify({
                            apiKey: apiConfig.key,
                            requestBody: qwenRequestBody
                        });
                        fetchOptions.headers = {
                            'Content-Type': 'application/json'
                        };
                    }
                }

                const response = await fetch(apiConfig.url, fetchOptions);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API调用失败: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                
                // 根据不同API解析响应
                if (apiConfig.url.includes('googleapis.com')) {
                    // Google Gemini响应格式
                    if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                        return data.candidates[0].content.parts[0].text;
                    }
                } else if (apiConfig.url.includes('dashscope.aliyuncs.com') || apiConfig.url.includes('vercel.app') || apiConfig.url.includes('workers.dev')) {
                    // 通义千问响应格式 (包括代理服务器)
                    if (data.output && data.output.text) {
                        return data.output.text;
                    }
                } else if (data.choices && data.choices[0]) {
                    // OpenAI和智谱AI响应格式
                    if (data.choices[0].message) {
                        return data.choices[0].message.content;
                    } else if (data.choices[0].text) {
                        return data.choices[0].text;
                    }
                }
                
                throw new Error('API响应格式不正确');
                
            } catch (error) {
                // 如果是Gemini API的模型未找到错误，尝试使用其他模型
                if (error.message.includes('NOT_FOUND') && apiConfig.url.includes('googleapis.com')) {
                    // 尝试使用gemini-pro模型
                    const fallbackUrl = apiConfig.url.replace('gemini-1.5-flash', 'gemini-pro');
                    try {
                        const fallbackResponse = await fetch(fallbackUrl, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            if (fallbackData.candidates && fallbackData.candidates[0] && fallbackData.candidates[0].content && fallbackData.candidates[0].content.parts && fallbackData.candidates[0].content.parts[0]) {
                                return fallbackData.candidates[0].content.parts[0].text;
                            }
                        }
                    } catch (fallbackError) {
                        console.warn('备用Gemini模型也失败:', fallbackError);
                    }
                }
                
                // 如果是CORS错误，提供更友好的错误信息
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    throw new Error('API调用受浏览器安全限制阻止，建议使用支持CORS的API服务或通过服务器代理调用');
                }
                throw error;
            }
        }

        // 生成AI提示词（安全版本）
        function generatePrompt(examData) {
            const categoryText = Object.keys(examData.categories).length > 0 ? 
                Object.entries(examData.categories).map(([category, stats]) => 
                    `${category}：${stats.correct}/${stats.total} (${(stats.correct/stats.total*100).toFixed(1)}%)`
                ).join('\n') : '暂无分类数据';

            // 生成完整的题目详情
            const detailedQuestionsText = examData.detailedQuestions && examData.detailedQuestions.length > 0 ? 
                examData.detailedQuestions.map((q, index) => {
                    return `
【题目${q.questionNumber}】- ${q.category} - ${q.type}
题目：${q.question}
选项：
A. ${q.options.A}
B. ${q.options.B}
C. ${q.options.C}
D. ${q.options.D}
正确答案：${q.correctAnswer}
学员答案：${q.userAnswer || '未作答'}
答题结果：${q.isCorrect ? '✓ 正确' : '✗ 错误'}${q.explanation ? '\n解析：' + q.explanation : ''}
                    `.trim();
                }).join('\n\n') : '无题目详情';

            return `
作为专业的医学教育评估专家，请根据以下完整的考试数据生成详细的个性化学习评估报告：

=== 考试基本信息 ===
- 考试总题数：${examData.totalQuestions}题
- 答对题数：${examData.correctCount}题  
- 答题正确率：${examData.accuracy}%
- 考试用时：${examData.duration}分钟
- 考试时间：${examData.examDetails.startTime ? new Date(examData.examDetails.startTime).toLocaleString() : '未记录'}

=== 各知识领域表现统计 ===
${categoryText}

=== 完整题目作答情况 ===
${detailedQuestionsText}

=== 报告生成要求 ===
请基于以上完整的考试数据，生成一份专业的个性化学习评估报告，包含以下内容：

1. **总体表现评价**：基于答题正确率、用时等维度进行综合评价
2. **优势领域分析**：识别学员表现突出的知识领域和题型
3. **薄弱环节诊断**：详细分析错误题目，找出知识盲点和常见错误模式
4. **个性化学习建议**：针对具体的错误题目和薄弱环节，提供精准的学习建议
5. **复习重点规划**：制定针对性的复习计划和提升方向

**报告要求**：
- 分析要深入具体，结合实际的错题进行分析
- 建议要可操作，包含具体的学习方法和资源
- 语言专业但易懂，体现医学教育的专业性
- 字数控制在600-800字之间，结构清晰

请开始生成报告：
            `.trim();
        }

        // 本地生成报告（备选方案）
        function generateLocalReport(examData) {
            const accuracy = parseFloat(examData.accuracy);
            let report = '';

            // 总体表现评价
            report += '📈 **总体表现评价**\n';
            if (accuracy >= 90) {
                report += `您的考试表现优秀，正确率达到${accuracy}%，展现了扎实的医学基础知识。`;
            } else if (accuracy >= 80) {
                report += `您的考试表现良好，正确率为${accuracy}%，基础知识掌握较为扎实，还有进步空间。`;
            } else if (accuracy >= 70) {
                report += `您的考试表现中等，正确率为${accuracy}%，部分知识点需要加强学习。`;
            } else if (accuracy >= 60) {
                report += `您的正确率为${accuracy}%，建议系统性复习相关医学知识点。`;
            } else {
                report += `您的正确率为${accuracy}%，建议从基础知识开始，系统性学习医学相关内容。`;
            }

            report += '\n\n';

            // 各领域分析
            report += '📊 **各领域表现分析**\n';
            const sortedCategories = Object.entries(examData.categories).sort((a, b) => 
                (b[1].correct / b[1].total) - (a[1].correct / a[1].total)
            );

            if (sortedCategories.length > 0) {
                const best = sortedCategories[0];
                const worst = sortedCategories[sortedCategories.length - 1];
                
                report += `• 优势领域：${best[0]} (${(best[1].correct/best[1].total*100).toFixed(1)}%)\n`;
                
                if (sortedCategories.length > 1) {
                    report += `• 薄弱领域：${worst[0]} (${(worst[1].correct/worst[1].total*100).toFixed(1)}%)\n`;
                }
                
                // 详细分类统计
                report += '\n各知识领域详细表现：\n';
                sortedCategories.forEach(([category, stats]) => {
                    const categoryAccuracy = (stats.correct/stats.total*100).toFixed(1);
                    const emoji = categoryAccuracy >= 80 ? '🟢' : categoryAccuracy >= 60 ? '🟡' : '🔴';
                    report += `${emoji} ${category}：${stats.correct}/${stats.total} (${categoryAccuracy}%)\n`;
                });
            }

            report += '\n';

            // 错误分析
            if (examData.wrongAnswers.length > 0) {
                report += '❌ **错误题目分析**\n';
                report += `本次考试中您答错了${examData.wrongAnswers.length}道题目，主要涉及：\n`;
                
                const errorCategories = {};
                examData.wrongAnswers.forEach(answer => {
                    const category = answer.question.category;
                    if (!errorCategories[category]) {
                        errorCategories[category] = 0;
                    }
                    errorCategories[category]++;
                });

                Object.entries(errorCategories).forEach(([category, count]) => {
                    report += `• ${category}：${count}题\n`;
                });

                report += '\n';
            }

            // 学习建议
            report += '💡 **学习建议**\n';
            if (examData.wrongAnswers.length > 0) {
                report += '1. 重点复习错误题目涉及的知识点\n';
                report += '2. 建议针对薄弱领域进行专项练习\n';
                report += '3. 定期回顾和巩固已掌握的知识\n';
                
                // 根据错误类型给出具体建议
                if (examData.wrongAnswers.some(a => a.question.type === 'multiple')) {
                    report += '4. 多选题练习：注意审题，考虑所有可能的正确选项\n';
                }
            } else {
                report += '1. 保持现有的学习节奏和方法\n';
                report += '2. 可以尝试更有挑战性的题目\n';
                report += '3. 关注最新的医学研究进展\n';
            }

            report += '\n';

            // 后续提升方向
            report += '🎯 **后续提升方向**\n';
            if (accuracy < 80) {
                report += '• 建议系统性学习医学基础理论\n';
                report += '• 多做练习题，提高解题熟练度\n';
                report += '• 重点关注薄弱知识领域\n';
            } else {
                report += '• 深入学习专业细分领域\n';
                report += '• 关注临床实践应用\n';
                report += '• 提高复杂题目的分析能力\n';
            }
            
            if (examData.duration > 0) {
                if (examData.duration < 5) {
                    report += '• 答题速度较快，可以更仔细地审题\n';
                } else if (examData.duration > 20) {
                    report += '• 可以提高答题速度，加强知识的熟练程度\n';
                }
            }
            
            report += '• 定期进行知识检测，及时查漏补缺';

            return report;
        }

        // 保存考试记录
        function saveExamRecord(type, data = {}) {
            try {
                let examRecords = JSON.parse(localStorage.getItem('examRecords') || '[]');
                
                const record = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type: type, // 'start' 或 'complete'
                    data: data
                };
                
                examRecords.unshift(record); // 添加到开头
                
                // 只保留最近50条记录
                if (examRecords.length > 50) {
                    examRecords = examRecords.slice(0, 50);
                }
                
                localStorage.setItem('examRecords', JSON.stringify(examRecords));
                console.log('考试记录已保存:', type, data);
            } catch (error) {
                console.error('保存考试记录失败:', error);
            }
        }

        // 重新开始考试
        function restartExam() {
            document.getElementById('resultScreen').classList.remove('show');
            document.getElementById('startScreen').style.display = 'block';
        }
    </script>
</body>
</html>
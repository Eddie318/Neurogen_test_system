<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>穆桥销售测验系统 - 管理后台 (v2.1)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f8fafc; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #4c51bf 0%, #805ad5 100%); color: white; padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; color: #4c51bf; margin-bottom: 10px; }
        .stat-label { color: #718096; font-size: 14px; }
        .card { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 30px; }
        .tab { padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; color: #718096; }
        .tab.active { color: #4c51bf; border-bottom-color: #4c51bf; font-weight: bold; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .table th { background: #f7fafc; font-weight: bold; color: #4a5568; }
        .table tr:hover { background: #f7fafc; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
        .btn-primary { background: #4c51bf; color: white; }
        .btn-primary:hover { background: #434190; }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #f56565; color: white; }
        .btn-danger:hover { background: #e53e3e; }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #4c51bf; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .search-box { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; margin-bottom: 20px; font-size: 16px; }
        .search-box:focus { outline: none; border-color: #4c51bf; }
        .score-badge { padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; }
        .score-excellent { background: #48bb78; }
        .score-good { background: #ed8936; }
        .score-poor { background: #f56565; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #4a5568; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: #4c51bf; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; border: 2px solid #e2e8f0; padding: 15px; border-radius: 6px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 12px; font-weight: bold; }
        .status-upcoming { background: #ed8936; }
        .status-active { background: #48bb78; }
        .status-expired { background: #a0aec0; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .stats-grid { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
            .table { font-size: 14px; overflow-x: auto; }
            .modal-content { padding: 20px; }
            .checkbox-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- 标题 -->
            <div class="header">
                <h1>📊 穆桥销售测验系统 - 管理后台 (v2.1)</h1>
                <p>Vue.js + FastAPI 管理面板 - 新增题库管理功能</p>
            </div>

            <!-- 统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ stats.totalQuestions }}</div>
                    <div class="stat-label">题库总数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.totalExams }}</div>
                    <div class="stat-label">考试记录</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.averageScore }}%</div>
                    <div class="stat-label">平均分数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.todayExams }}</div>
                    <div class="stat-label">今日考试</div>
                </div>
            </div>

            <!-- 选项卡 -->
            <div class="card">
                <div class="tabs">
                    <div 
                        class="tab" 
                        :class="{ active: activeTab === 'exams' }"
                        @click="activeTab = 'exams'; loadExamRecords()"
                    >
                        📝 考试记录
                    </div>
                    <div 
                        class="tab" 
                        :class="{ active: activeTab === 'questions' }"
                        @click="activeTab = 'questions'; loadQuestions()"
                    >
                        📚 题库管理
                    </div>
                    <div 
                        class="tab" 
                        :class="{ active: activeTab === 'exam-management' }"
                        @click="activeTab = 'exam-management'; loadExams()"
                    >
                        📝 考试管理
                    </div>
                    <div 
                        class="tab" 
                        :class="{ active: activeTab === 'config' }"
                        @click="activeTab = 'config'; loadConfig()"
                    >
                        ⚙️ 系统配置
                    </div>
                </div>

                <!-- 考试记录标签页 -->
                <div v-if="activeTab === 'exams'">
                    <input 
                        type="text" 
                        class="search-box" 
                        placeholder="搜索考生姓名..." 
                        v-model="examSearch"
                    >
                    
                    <div v-if="loadingExams" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 20px;">加载考试记录...</p>
                    </div>
                    
                    <table v-else class="table">
                        <thead>
                            <tr>
                                <th>考生姓名</th>
                                <th>分数</th>
                                <th>正确率</th>
                                <th>考试时间</th>
                                <th>用时</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="exam in filteredExams" :key="exam.id">
                                <td>{{ exam.userName || exam.user_name }}</td>
                                <td>
                                    <span 
                                        class="score-badge"
                                        :class="getScoreClass(exam.score)"
                                    >
                                        {{ exam.score }}分
                                    </span>
                                </td>
                                <td>{{ Math.round((exam.correctCount / exam.totalQuestions) * 100) }}%</td>
                                <td>{{ formatDate(exam.created_at) }}</td>
                                <td>{{ formatDuration(exam.duration) }}</td>
                                <td>
                                    <button class="btn btn-primary" @click="viewExamDetail(exam)">
                                        查看详情
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 题库管理标签页 -->
                <div v-if="activeTab === 'questions'">
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" @click="showAddQuestionModal">
                            ➕ 添加题目
                        </button>
                        <button class="btn btn-primary" @click="refreshQuestions">
                            🔄 刷新题库
                        </button>
                        <button class="btn btn-primary" @click="exportQuestions">
                            📥 导出题库JSON
                        </button>
                    </div>
                    
                    <div v-if="loadingQuestions" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 20px;">加载题库统计...</p>
                    </div>
                    
                    <div v-else-if="questionStats">
                        <!-- 题库统计信息 -->
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <div class="stat-value">{{ questionStats.total_questions }}</div>
                                <div class="stat-label">题目总数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ questionStats.statistics.single_choice }}</div>
                                <div class="stat-label">单选题</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ questionStats.statistics.multiple_choice }}</div>
                                <div class="stat-label">多选题</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ questionStats.statistics.categories }}</div>
                                <div class="stat-label">分类数量</div>
                            </div>
                        </div>
                        
                        <!-- 分类统计 -->
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #4a5568;">📊 分类统计</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div v-for="(count, category) in questionStats.category_breakdown" :key="category"
                                     style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-weight: bold; color: #4c51bf; font-size: 20px;">{{ count }}</div>
                                    <div style="color: #718096; font-size: 14px;">{{ category }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 题目类型统计 -->
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px;">
                            <h3 style="margin-bottom: 15px; color: #4a5568;">📋 题目类型分布</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div v-for="(count, type) in questionStats.type_breakdown" :key="type"
                                     style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-weight: bold; color: #48bb78; font-size: 20px;">{{ count }}</div>
                                    <div style="color: #718096; font-size: 14px;">{{ type }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 考试管理标签页 -->
                <div v-if="activeTab === 'exam-management'">
                    <!-- 每日考试设置 -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: #4a5568;">⏰ 每日考试设置</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label>开始时间</label>
                                <input type="time" class="form-input" v-model="dailyExamConfig.start_time">
                            </div>
                            <div class="form-group">
                                <label>结束时间</label>
                                <input type="time" class="form-input" v-model="dailyExamConfig.end_time">
                            </div>
                            <div class="form-group">
                                <label>题目数量</label>
                                <input type="number" class="form-input" v-model="dailyExamConfig.question_count" min="1" max="10" readonly>
                                <small style="color: #718096; font-size: 12px;">固定3题</small>
                            </div>
                            <div class="form-group">
                                <label>考试时长（分钟）</label>
                                <input type="number" class="form-input" v-model="dailyExamConfig.duration_minutes" min="1" max="60" readonly>
                                <small style="color: #718096; font-size: 12px;">固定10分钟</small>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-success" @click="saveDailyExamConfig" :disabled="savingDailyConfig">
                                {{ savingDailyConfig ? '保存中...' : '💾 保存设置' }}
                            </button>
                            <div v-if="dailyConfigStatus" :style="{ color: dailyConfigStatus.success ? '#48bb78' : '#f56565' }">
                                {{ dailyConfigStatus.message }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 每日考试统计 -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #4a5568;">📈 每日考试统计</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" class="form-input" v-model="selectedReportDate" style="width: auto;">
                                <button class="btn btn-primary" @click="loadDailyReport">查看报告</button>
                                <button class="btn btn-success" @click="generateAllReports">生成报告</button>
                            </div>
                        </div>
                        
                        <div v-if="dailyReport && dailyReport.has_data">
                            <div class="stats-grid" style="margin-bottom: 20px;">
                                <div class="stat-card">
                                    <div class="stat-value">{{ dailyReport.statistics.total_participants }}</div>
                                    <div class="stat-label">参与人数</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">{{ dailyReport.statistics.average_score }}</div>
                                    <div class="stat-label">平均分数</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">{{ formatDuration(dailyReport.statistics.average_duration_seconds) }}</div>
                                    <div class="stat-label">平均用时</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">{{ dailyReport.statistics.score_distribution.excellent.percentage }}%</div>
                                    <div class="stat-label">优秀率(≥90分)</div>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 15px; border-radius: 6px;">
                                <h4 style="margin-bottom: 15px; color: #4a5568;">分数分布</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                                    <div style="text-align: center; padding: 10px; background: #48bb78; color: white; border-radius: 4px;">
                                        <div style="font-weight: bold;">{{ dailyReport.statistics.score_distribution.excellent.count }}</div>
                                        <div style="font-size: 12px;">优秀(90-100)</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: #ed8936; color: white; border-radius: 4px;">
                                        <div style="font-weight: bold;">{{ dailyReport.statistics.score_distribution.good.count }}</div>
                                        <div style="font-size: 12px;">良好(70-89)</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: #4299e1; color: white; border-radius: 4px;">
                                        <div style="font-weight: bold;">{{ dailyReport.statistics.score_distribution.average.count }}</div>
                                        <div style="font-size: 12px;">及格(60-69)</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: #f56565; color: white; border-radius: 4px;">
                                        <div style="font-weight: bold;">{{ dailyReport.statistics.score_distribution.poor.count }}</div>
                                        <div style="font-size: 12px;">不及格(<60)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div v-else-if="dailyReport && !dailyReport.has_data" style="text-align: center; padding: 20px; color: #718096;">
                            📝 {{ selectedReportDate }} 暂无考试记录
                        </div>
                    </div>
                    
                    <!-- 考试记录列表 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #4a5568;">📊 考试记录</h3>
                        <button class="btn btn-primary" @click="loadExams">
                            🔄 刷新列表
                        </button>
                    </div>
                    
                    <div v-if="loadingExamManagement" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 20px;">加载考试记录...</p>
                    </div>
                    
                    <table v-else class="table">
                        <thead>
                            <tr>
                                <th>考试名称</th>
                                <th>类型</th>
                                <th>题目数</th>
                                <th>时长</th>
                                <th>状态</th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="exam in examList" :key="exam.id">
                                <td>{{ exam.exam_name }}</td>
                                <td>{{ exam.exam_type === 'formal' ? '正式考试' : '随机练习' }}</td>
                                <td>{{ exam.total_questions }}题</td>
                                <td>{{ exam.duration_minutes }}分钟</td>
                                <td>
                                    <span 
                                        class="status-badge"
                                        :class="'status-' + exam.status"
                                    >
                                        {{ getStatusText(exam.status) }}
                                    </span>
                                </td>
                                <td>{{ formatDate(exam.start_time) }}</td>
                                <td>{{ formatDate(exam.end_time) }}</td>
                                <td>
                                    <button class="btn btn-primary" @click="viewExamQuestions(exam)" style="margin-right: 5px;">
                                        查看题目
                                    </button>
                                    <button class="btn btn-danger" @click="deleteExam(exam.id)">
                                        删除
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 系统配置标签页 -->
                <div v-if="activeTab === 'config'">
                    <div v-if="loadingConfig" class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 20px;">加载配置...</p>
                    </div>
                    
                    <div v-else>
                        <!-- API配置部分 -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                            <h3 style="margin-bottom: 20px;">🤖 AI配置</h3>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>API提供商</label>
                                <select class="form-input" v-model="apiConfig.provider">
                                    <option value="qwen">通义千问 (Qwen)</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="custom">自定义</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>API地址</label>
                                <input 
                                    type="text" 
                                    class="form-input" 
                                    v-model="apiConfig.url" 
                                    placeholder="https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
                                >
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>模型名称</label>
                                <input 
                                    type="text" 
                                    class="form-input" 
                                    v-model="apiConfig.model" 
                                    placeholder="qwen-turbo"
                                >
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>API密钥</label>
                                <input 
                                    type="password" 
                                    class="form-input" 
                                    v-model="apiConfig.key" 
                                    placeholder="请输入API密钥"
                                >
                            </div>
                            
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button 
                                    class="btn btn-success" 
                                    @click="saveApiConfig"
                                    :disabled="savingConfig"
                                >
                                    {{ savingConfig ? '保存中...' : '💾 保存配置' }}
                                </button>
                                
                                <button 
                                    class="btn btn-primary" 
                                    @click="testApiConnection"
                                    :disabled="testingConnection || !apiConfig.key"
                                >
                                    {{ testingConnection ? '测试中...' : '🔗 测试连接' }}
                                </button>
                                
                                <span v-if="connectionStatus" :style="{ color: connectionStatus.success ? '#48bb78' : '#f56565' }">
                                    {{ connectionStatus.message }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- API状态显示 -->
                        <div style="background: #fff; padding: 20px; border-radius: 8px; border: 2px solid #e2e8f0; margin-bottom: 30px;">
                            <h3 style="margin-bottom: 15px;">📊 API状态</h3>
                            <p><strong>API密钥状态:</strong> 
                                <span :style="{ color: (config.apiConfig && config.apiConfig.enabled) ? '#48bb78' : '#f56565' }">
                                    {{ (config.apiConfig && config.apiConfig.enabled) ? '✅ 已配置' : '❌ 未配置' }}
                                </span>
                            </p>
                            <p><strong>AI报告功能:</strong> 
                                <span :style="{ color: (config.apiConfig && config.apiConfig.enabled) ? '#48bb78' : '#f56565' }">
                                    {{ (config.apiConfig && config.apiConfig.enabled) ? '✅ 启用' : '❌ 禁用' }}
                                </span>
                            </p>
                            <p v-if="config.apiConfig && config.apiConfig.enabled">
                                <strong>当前提供商:</strong> {{ config.apiConfig.provider || 'qwen' }}<br>
                                <strong>当前模型:</strong> {{ config.apiConfig.model || 'qwen-turbo' }}
                            </p>
                        </div>
                        
                        <!-- 系统状态 -->
                        <div style="background: #fff; padding: 20px; border-radius: 8px; border: 2px solid #e2e8f0;">
                            <h3 style="margin-bottom: 15px;">🖥️ 系统状态</h3>
                            <p><strong>数据库连接:</strong> <span style="color: #48bb78;">✅ 正常</span></p>
                            <p><strong>API服务:</strong> <span style="color: #48bb78;">✅ 运行中</span></p>
                            <p><strong>题库数量:</strong> {{ stats.totalQuestions }}道</p>
                            <p><strong>考试记录:</strong> {{ stats.totalExams }}条</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 创建考试弹窗 -->
        <div v-if="showExamModal" class="modal" @click="closeModal($event)">
            <div class="modal-content">
                <h2>{{ isEditMode ? '编辑考试' : '创建新考试' }}</h2>
                
                <div class="form-group">
                    <label>考试名称</label>
                    <input type="text" class="form-input" v-model="examForm.exam_name" placeholder="请输入考试名称">
                </div>
                
                <div class="form-group">
                    <label>考试描述</label>
                    <textarea class="form-input form-textarea" v-model="examForm.description" placeholder="请输入考试描述（可选）"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>考试类型</label>
                        <select class="form-input" v-model="examForm.exam_type">
                            <option value="formal">正式考试</option>
                            <option value="practice">随机练习</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>考试时长（分钟）</label>
                        <input type="number" class="form-input" v-model="examForm.duration_minutes" min="1" max="180">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>开始时间</label>
                        <input type="datetime-local" class="form-input" v-model="examForm.start_time">
                    </div>
                    
                    <div class="form-group">
                        <label>结束时间</label>
                        <input type="datetime-local" class="form-input" v-model="examForm.end_time">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>选择题目（{{ selectedQuestions.length }} / {{ availableQuestions.length }}）</label>
                    <div class="checkbox-group">
                        <div v-for="question in availableQuestions" :key="question.id" class="checkbox-item">
                            <input 
                                type="checkbox" 
                                :value="question.id" 
                                v-model="selectedQuestions"
                                :id="'q-' + question.id"
                            >
                            <label :for="'q-' + question.id" style="margin: 0; font-weight: normal; cursor: pointer;">
                                {{ question.question.substring(0, 50) }}{{ question.question.length > 50 ? '...' : '' }}
                            </label>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button class="btn btn-primary" @click="closeExamModal">取消</button>
                    <button class="btn btn-success" @click="saveExam" :disabled="!canSaveExam">
                        {{ isEditMode ? '更新' : '创建' }}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 添加题目弹窗 -->
        <div v-if="showAddQuestionModal" class="modal" @click="closeAddQuestionModal($event)">
            <div class="modal-content">
                <h2>添加新题目</h2>
                
                <div class="form-group">
                    <label>题目分类</label>
                    <input type="text" class="form-input" v-model="questionForm.category" placeholder="请输入题目分类（如：产品知识、销售技巧等）">
                </div>
                
                <div class="form-group">
                    <label>题目类型</label>
                    <select class="form-input" v-model="questionForm.question_type">
                        <option value="single">单选题</option>
                        <option value="multiple">多选题</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>题目内容</label>
                    <textarea class="form-input form-textarea" v-model="questionForm.question" placeholder="请输入题目内容"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>选项A</label>
                        <input type="text" class="form-input" v-model="questionForm.option_a" placeholder="选项A内容">
                    </div>
                    
                    <div class="form-group">
                        <label>选项B</label>
                        <input type="text" class="form-input" v-model="questionForm.option_b" placeholder="选项B内容">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>选项C（可选）</label>
                        <input type="text" class="form-input" v-model="questionForm.option_c" placeholder="选项C内容">
                    </div>
                    
                    <div class="form-group">
                        <label>选项D（可选）</label>
                        <input type="text" class="form-input" v-model="questionForm.option_d" placeholder="选项D内容">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>正确答案</label>
                    <input type="text" class="form-input" v-model="questionForm.answer" 
                           :placeholder="questionForm.question_type === 'single' ? '输入正确答案（如：A）' : '输入正确答案（如：AB 或 ACD）'">
                    <small style="color: #718096; font-size: 12px; margin-top: 5px; display: block;">
                        {{ questionForm.question_type === 'single' ? '单选题请输入一个选项字母' : '多选题请输入多个选项字母，无空格' }}
                    </small>
                </div>
                
                <div class="form-group">
                    <label>答案解析（可选）</label>
                    <textarea class="form-input form-textarea" v-model="questionForm.explanation" placeholder="请输入答案解析"></textarea>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button class="btn btn-primary" @click="closeAddQuestionModal">取消</button>
                    <button class="btn btn-success" @click="saveQuestion" :disabled="!canSaveQuestion">
                        添加题目
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 'exams',
                    examSearch: '',
                    loadingExams: false,
                    loadingQuestions: false,
                    loadingConfig: false,
                    loadingExamManagement: false,
                    examRecords: [],
                    questionBank: {},
                    questionStats: null,
                    config: {},
                    examList: [],
                    availableQuestions: [],
                    showExamModal: false,
                    showAddQuestionModal: false,
                    isEditMode: false,
                    selectedQuestions: [],
                    examForm: {
                        exam_name: '',
                        description: '',
                        exam_type: 'formal',
                        duration_minutes: 30,
                        start_time: '',
                        end_time: ''
                    },
                    questionForm: {
                        category: '',
                        question_type: 'single',
                        question: '',
                        option_a: '',
                        option_b: '',
                        option_c: '',
                        option_d: '',
                        answer: '',
                        explanation: ''
                    },
                    // 每日考试配置
                    dailyExamConfig: {
                        start_time: '08:00',
                        end_time: '20:00',
                        question_count: 3,
                        duration_minutes: 10
                    },
                    savingDailyConfig: false,
                    dailyConfigStatus: null,
                    // 每日报告相关
                    selectedReportDate: new Date().toISOString().split('T')[0],
                    dailyReport: null,
                    // API配置
                    apiConfig: {
                        provider: 'qwen',
                        url: 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                        model: 'qwen-turbo',
                        key: ''
                    },
                    savingConfig: false,
                    testingConnection: false,
                    connectionStatus: null,
                    stats: {
                        totalQuestions: 0,
                        totalExams: 0,
                        averageScore: 0,
                        todayExams: 0
                    },
                    apiBase: 'http://127.0.0.1:8002/api'
                }
            },
            computed: {
                filteredExams() {
                    if (!this.examSearch) return this.examRecords;
                    return this.examRecords.filter(exam => 
                        (exam.userName || exam.user_name || '').toLowerCase()
                            .includes(this.examSearch.toLowerCase())
                    );
                },
                canSaveExam() {
                    return this.examForm.exam_name.trim() && 
                           this.examForm.start_time && 
                           this.examForm.end_time && 
                           this.selectedQuestions.length > 0;
                },
                canSaveQuestion() {
                    return this.questionForm.category.trim() && 
                           this.questionForm.question.trim() && 
                           this.questionForm.option_a.trim() && 
                           this.questionForm.option_b.trim() && 
                           this.questionForm.answer.trim();
                }
            },
            mounted() {
                this.loadStats();
                this.loadExamRecords();
            },
            methods: {
                async loadStats() {
                    try {
                        // 获取题库统计
                        const questionsRes = await axios.get(`${this.apiBase}/master-questions`);
                        this.stats.totalQuestions = questionsRes.data.totalQuestions;
                        
                        // 获取考试记录统计
                        const examsRes = await axios.get(`${this.apiBase}/exam-records`);
                        const exams = examsRes.data;
                        this.stats.totalExams = exams.length;
                        
                        if (exams.length > 0) {
                            const totalScore = exams.reduce((sum, exam) => sum + exam.score, 0);
                            this.stats.averageScore = Math.round(totalScore / exams.length);
                            
                            // 计算今日考试数
                            const today = new Date().toDateString();
                            this.stats.todayExams = exams.filter(exam => 
                                new Date(exam.created_at).toDateString() === today
                            ).length;
                        }
                    } catch (error) {
                        console.error('加载统计信息失败:', error);
                    }
                },
                async loadExamRecords() {
                    this.loadingExams = true;
                    try {
                        const response = await axios.get(`${this.apiBase}/exam-records`);
                        this.examRecords = response.data;
                    } catch (error) {
                        alert('加载考试记录失败: ' + error.message);
                    } finally {
                        this.loadingExams = false;
                    }
                },
                async loadQuestions() {
                    this.loadingQuestions = true;
                    try {
                        const response = await axios.get(`${this.apiBase}/questions/stats`);
                        this.questionStats = response.data;
                    } catch (error) {
                        alert('加载题库统计失败: ' + error.message);
                    } finally {
                        this.loadingQuestions = false;
                    }
                },
                async loadConfig() {
                    this.loadingConfig = true;
                    try {
                        const response = await axios.get(`${this.apiBase}/master-config`);
                        this.config = response.data;
                        
                        // 如果已有配置，加载到表单中
                        if (this.config.apiConfig) {
                            this.apiConfig = {
                                provider: this.config.apiConfig.provider || 'qwen',
                                url: this.config.apiConfig.url || 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                                model: this.config.apiConfig.model || 'qwen-turbo',
                                key: this.config.apiConfig.key || ''
                            };
                        }
                    } catch (error) {
                        alert('加载配置失败: ' + error.message);
                    } finally {
                        this.loadingConfig = false;
                    }
                },
                async refreshQuestions() {
                    await this.loadQuestions();
                    await this.loadStats();
                    alert('题库已刷新');
                },
                
                // 题库管理方法
                showAddQuestionModal() {
                    this.resetQuestionForm();
                    this.showAddQuestionModal = true;
                },
                
                resetQuestionForm() {
                    this.questionForm = {
                        category: '',
                        question_type: 'single',
                        question: '',
                        option_a: '',
                        option_b: '',
                        option_c: '',
                        option_d: '',
                        answer: '',
                        explanation: ''
                    };
                },
                
                closeAddQuestionModal(event) {
                    if (event && !event.target.classList.contains('modal')) {
                        return;
                    }
                    this.showAddQuestionModal = false;
                    this.resetQuestionForm();
                },
                
                async saveQuestion() {
                    if (!this.canSaveQuestion) {
                        alert('请填写完整的题目信息');
                        return;
                    }
                    
                    try {
                        const response = await axios.post(`${this.apiBase}/questions`, this.questionForm);
                        
                        alert('题目添加成功！');
                        this.closeAddQuestionModal();
                        this.loadQuestions();
                        this.loadStats();
                        
                    } catch (error) {
                        alert('添加题目失败: ' + error.message);
                        console.error(error);
                    }
                },
                
                async exportQuestions() {
                    try {
                        const response = await axios.get(`${this.apiBase}/questions/export`);
                        
                        // 创建下载链接
                        const blob = new Blob([JSON.stringify(response.data, null, 2)], {
                            type: 'application/json'
                        });
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `题库导出_${new Date().toISOString().slice(0,10)}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        
                        alert('题库导出成功！');
                        
                    } catch (error) {
                        alert('导出题库失败: ' + error.message);
                        console.error(error);
                    }
                },
                viewExamDetail(exam) {
                    alert(`考试详情：\n姓名: ${exam.userName || exam.user_name}\n分数: ${exam.score}分\n用时: ${this.formatDuration(exam.duration)}`);
                },
                getScoreClass(score) {
                    if (score >= 90) return 'score-excellent';
                    if (score >= 70) return 'score-good';
                    return 'score-poor';
                },
                formatDate(dateString) {
                    if (!dateString) return '-';
                    return new Date(dateString).toLocaleString('zh-CN');
                },
                formatDuration(seconds) {
                    if (!seconds) return '-';
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}分${secs}秒`;
                },
                
                // 考试管理方法
                async loadExams() {
                    this.loadingExamManagement = true;
                    try {
                        const response = await axios.get(`${this.apiBase}/exams`);
                        this.examList = response.data;
                    } catch (error) {
                        alert('加载考试列表失败: ' + error.message);
                    } finally {
                        this.loadingExamManagement = false;
                    }
                },
                
                async loadAvailableQuestions() {
                    try {
                        const response = await axios.get(`${this.apiBase}/questions`);
                        this.availableQuestions = response.data;
                    } catch (error) {
                        console.error('加载题目失败:', error);
                    }
                },
                
                async showCreateExamModal() {
                    this.isEditMode = false;
                    this.resetExamForm();
                    await this.loadAvailableQuestions();
                    this.showExamModal = true;
                },
                
                resetExamForm() {
                    this.examForm = {
                        exam_name: '',
                        description: '',
                        exam_type: 'formal',
                        duration_minutes: 30,
                        start_time: '',
                        end_time: ''
                    };
                    this.selectedQuestions = [];
                },
                
                closeExamModal() {
                    this.showExamModal = false;
                    this.resetExamForm();
                },
                
                closeModal(event) {
                    if (event.target.classList.contains('modal')) {
                        this.closeExamModal();
                    }
                },
                
                async saveExam() {
                    if (!this.canSaveExam) {
                        alert('请填写完整信息');
                        return;
                    }
                    
                    try {
                        const examData = {
                            ...this.examForm,
                            question_ids: this.selectedQuestions
                        };
                        
                        const response = await axios.post(`${this.apiBase}/exams`, examData);
                        
                        alert('考试创建成功！');
                        this.closeExamModal();
                        this.loadExams();
                        this.loadStats();
                        
                    } catch (error) {
                        alert('创建考试失败: ' + error.message);
                        console.error(error);
                    }
                },
                
                async deleteExam(examId) {
                    if (!confirm('确定要删除这个考试吗？')) {
                        return;
                    }
                    
                    try {
                        await axios.delete(`${this.apiBase}/exams/${examId}`);
                        alert('考试删除成功！');
                        this.loadExams();
                        this.loadStats();
                    } catch (error) {
                        alert('删除考试失败: ' + error.message);
                    }
                },
                
                async viewExamQuestions(exam) {
                    try {
                        const response = await axios.get(`${this.apiBase}/exams/${exam.id}`);
                        const examDetail = response.data;
                        const questions = examDetail.questions.map(q => q.question.substring(0, 100) + '...').join('\n');
                        alert(`考试题目 (${examDetail.total_questions}道):\n\n${questions}`);
                    } catch (error) {
                        alert('获取考试详情失败: ' + error.message);
                    }
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'upcoming': '未开始',
                        'active': '进行中', 
                        'expired': '已结束'
                    };
                    return statusMap[status] || status;
                },
                
                // 每日考试配置方法
                async saveDailyExamConfig() {
                    this.savingDailyConfig = true;
                    this.dailyConfigStatus = null;
                    
                    try {
                        const configData = {
                            daily_exam_start_time: this.dailyExamConfig.start_time,
                            daily_exam_end_time: this.dailyExamConfig.end_time,
                            daily_exam_question_count: this.dailyExamConfig.question_count,
                            daily_exam_duration_minutes: this.dailyExamConfig.duration_minutes
                        };
                        
                        const response = await axios.post(`${this.apiBase}/daily-exam-config`, configData);
                        
                        if (response.data.success) {
                            this.dailyConfigStatus = {
                                success: true,
                                message: '✅ 每日考试设置保存成功！'
                            };
                        } else {
                            this.dailyConfigStatus = {
                                success: false,
                                message: '❌ 保存失败: ' + response.data.message
                            };
                        }
                        
                    } catch (error) {
                        this.dailyConfigStatus = {
                            success: false,
                            message: '❌ 保存失败: ' + error.message
                        };
                        console.error(error);
                    } finally {
                        this.savingDailyConfig = false;
                    }
                },
                
                // 每日报告相关方法
                async loadDailyReport() {
                    try {
                        const response = await axios.get(`${this.apiBase}/daily-exam-report`, {
                            params: { date: this.selectedReportDate }
                        });
                        this.dailyReport = response.data;
                    } catch (error) {
                        alert('加载每日报告失败: ' + error.message);
                        console.error(error);
                    }
                },
                
                async generateAllReports() {
                    try {
                        const response = await axios.post(`${this.apiBase}/generate-daily-reports`);
                        
                        if (response.data.success) {
                            alert(`✅ ${response.data.message}`);
                            // 重新加载当前日期的报告
                            await this.loadDailyReport();
                        } else {
                            alert('❌ 生成报告失败: ' + response.data.message);
                        }
                        
                    } catch (error) {
                        alert('❌ 生成报告失败: ' + error.message);
                        console.error(error);
                    }
                },
                
                // API配置相关方法
                async saveApiConfig() {
                    this.savingConfig = true;
                    this.connectionStatus = null;
                    
                    try {
                        const configData = {
                            provider: this.apiConfig.provider,
                            url: this.apiConfig.url,
                            model: this.apiConfig.model,
                            key: this.apiConfig.key,
                            enabled: true
                        };
                        
                        const response = await axios.post(`${this.apiBase}/api-config`, configData);
                        
                        if (response.data.success) {
                            alert('✅ API配置保存成功！');
                            await this.loadConfig(); // 重新加载配置
                            await this.loadStats(); // 更新统计
                        } else {
                            alert('❌ API配置保存失败: ' + response.data.message);
                        }
                        
                    } catch (error) {
                        alert('❌ 保存配置失败: ' + error.message);
                        console.error(error);
                    } finally {
                        this.savingConfig = false;
                    }
                },
                
                async testApiConnection() {
                    this.testingConnection = true;
                    this.connectionStatus = null;
                    
                    try {
                        const testData = {
                            provider: this.apiConfig.provider,
                            url: this.apiConfig.url,
                            model: this.apiConfig.model,
                            key: this.apiConfig.key
                        };
                        
                        const response = await axios.post(`${this.apiBase}/test-api-connection`, testData);
                        
                        if (response.data.success) {
                            this.connectionStatus = {
                                success: true,
                                message: '✅ 连接成功！'
                            };
                        } else {
                            this.connectionStatus = {
                                success: false,
                                message: '❌ 连接失败: ' + response.data.error
                            };
                        }
                        
                    } catch (error) {
                        this.connectionStatus = {
                            success: false,
                            message: '❌ 测试失败: ' + error.message
                        };
                        console.error(error);
                    } finally {
                        this.testingConnection = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>